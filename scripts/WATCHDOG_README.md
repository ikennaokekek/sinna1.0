# Watchdog Service Documentation

## Overview

The Sinna Watchdog is an automated monitoring and auto-healing system that:
- Monitors Render logs every 10 minutes
- Detects recurring error patterns
- Triggers auto-healing tests when issues are detected
- Generates reports for manual review

## Architecture

The watchdog runs as a separate Render Background Worker service that:
1. Polls Render API logs every 10 minutes
2. Scans for error patterns matching actual codebase error messages
3. Counts occurrences and compares against thresholds
4. Triggers `tests/videoTransform.heal.ts` when issues detected
5. Logs findings to `logs/watchdog.log`
6. Optionally sends Slack notifications

## Error Patterns Monitored

The watchdog monitors for these error patterns (matching actual codebase):

### Queue/Worker Failures
- `captions.*failed` - Captions queue failures
- `ad.*failed` - Audio description queue failures
- `color.*failed` - Color analysis queue failures
- `video-transform.*failed` - Video transformation failures
- `transcription failed` - Transcription errors
- `TTS failed` - Text-to-speech errors
- `Video transformation failed` - Video transform errors

### Timeouts
- `assemblyai_timeout` - AssemblyAI API timeout
- `assemblyai_error` - AssemblyAI API errors
- `timeout` - General timeout errors

### Redis/Connection Issues
- `Redis unavailable` - Redis connection failures
- `Redis.*error` - Redis errors
- `Worker Redis unavailable` - Worker Redis connection issues

### R2/Storage Issues
- `Failed to upload` - R2 upload failures
- `R2 credentials are not configured` - Missing R2 config
- `R2_BUCKET environment variable is not set` - Missing bucket config
- `Failed to download from R2` - R2 download failures
- `Failed to upload.*to R2` - Specific R2 upload errors

### Cloudinary Issues
- `Cloudinary upload failed` - Cloudinary upload errors
- `Cloudinary.*failed` - General Cloudinary errors
- `CLOUDINARY_URL not configured` - Missing Cloudinary config

### Job Processing Errors
- `Missing videoUrl` - Missing video URL in job data
- `assemblyai_create_failed` - AssemblyAI job creation failures
- `missing_video_url` - Video URL validation errors

### Server Errors
- `500 Internal Server Error` - HTTP 500 errors
- `Internal Server Error` - General server errors

## Alert Thresholds

Each pattern has a threshold (default: 3 occurrences):
- `captions.*failed`: 3
- `ad.*failed`: 3
- `color.*failed`: 3
- `video-transform.*failed`: 3
- `Redis unavailable`: 2
- `Failed to upload`: 5
- `500 Internal Server Error`: 5
- `timeout`: 5
- Default: 3

## Setup

### 1. Get Render API Credentials

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Navigate to **Account Settings** â†’ **API Keys**
3. Click **Create API Key**
4. Copy the API key (starts with `rnd_`)

### 2. Get Service ID

1. Go to your Render service (e.g., `sinna-api`)
2. Copy the Service ID from the URL or service details page
3. Format: `srv-xxxxxxxxxxxxx`

### 3. Set Environment Variables

In Render Dashboard â†’ Environment Variables:

**Required:**
- `RENDER_SERVICE_ID` - Your service ID (e.g., `srv-xxxxxxxxxxxxx`)
- `RENDER_API_KEY` - Your Render API key (e.g., `rnd_xxxxxxxxxxxxx`)

**Optional (for auto-heal tests):**
- `TEST_API_KEY` or `API_KEY` - API key for running tests
- `TEST_VIDEO_URL` - Test video URL (defaults to Big Buck Bunny)
- `SLACK_WEBHOOK_URL` - Slack webhook for notifications

### 4. Deploy

The watchdog is automatically deployed via `render.yaml`:

```yaml
- type: worker
  name: sinna-watchdog
  runtime: node
  plan: free
  startCommand: pnpm watchdog
```

## Usage

### Local Development

```bash
# Set environment variables
export RENDER_SERVICE_ID=srv-xxxxxxxxxxxxx
export RENDER_API_KEY=rnd_xxxxxxxxxxxxx
export E2E_BASE_URL=http://localhost:4000
export TEST_API_KEY=sk_test_your_key

# Run watchdog
pnpm watchdog

# Or with watch mode (auto-restart on file changes)
pnpm watchdog:dev
```

### Production

The watchdog runs automatically as a Render Background Worker:
- Starts automatically on deploy
- Runs continuously
- Polls logs every 10 minutes
- Triggers auto-healing when issues detected

## Output Files

### `logs/watchdog.log`

Contains timestamped entries:
```
[2025-01-01T12:00:00.000Z] âš ï¸  Issues detected: captions.*failed (5 occurrences, threshold: 3), Redis unavailable (2 occurrences, threshold: 2)
[2025-01-01T12:10:00.000Z] âœ… No recurring errors detected above thresholds.
```

### `tests/reports/autoheal-report.md`

Generated by auto-heal tests when triggered:
- Summary statistics
- Detailed results per preset
- Fixes applied
- Configuration validation

## Notifications

### Slack Integration (Optional)

Set `SLACK_WEBHOOK_URL` environment variable:

1. Create Slack Incoming Webhook:
   - Go to https://api.slack.com/apps
   - Create new app â†’ Incoming Webhooks
   - Add webhook URL to `SLACK_WEBHOOK_URL`

2. Watchdog will send messages like:
   ```
   ðŸš¨ Sinna Watchdog Alert
   
   Issues detected:
   - captions.*failed (5x)
   - Redis unavailable (2x)
   
   Auto-healing triggered. Check logs for details.
   ```

## Troubleshooting

### Watchdog Not Starting

1. Check environment variables are set:
   ```bash
   echo $RENDER_SERVICE_ID
   echo $RENDER_API_KEY
   ```

2. Check Render logs for errors:
   - Go to Render Dashboard â†’ `sinna-watchdog` service â†’ Logs

3. Verify API key permissions:
   - API key must have `read_logs` permission
   - Check Render Dashboard â†’ API Keys â†’ Permissions

### No Logs Returned

1. Verify service ID is correct:
   - Service ID format: `srv-xxxxxxxxxxxxx`
   - Check Render Dashboard â†’ Service â†’ Details

2. Verify API key has access:
   - API key must belong to same account as service
   - Check Render Dashboard â†’ API Keys â†’ Owner

### Auto-Heal Not Triggering

1. Check thresholds:
   - Errors must occur >= threshold times
   - Default threshold is 3 occurrences

2. Check error patterns:
   - Patterns use regex matching
   - Case-insensitive matching
   - Check `logs/watchdog.log` for detected patterns

3. Verify auto-heal test suite:
   ```bash
   pnpm test:heal
   ```

### Too Many False Positives

1. Adjust thresholds:
   - Edit `ALERT_THRESHOLDS` in `scripts/watchdog.ts`
   - Increase threshold for noisy patterns

2. Refine patterns:
   - Make regex patterns more specific
   - Remove overly broad patterns

## Monitoring

### Check Watchdog Status

```bash
# View watchdog logs
tail -f logs/watchdog.log

# View auto-heal reports
cat tests/reports/autoheal-report.md
```

### Render Dashboard

1. Go to Render Dashboard â†’ `sinna-watchdog` service
2. Check:
   - Service status (should be "Running")
   - Recent logs
   - Resource usage (CPU/Memory)

## Best Practices

1. **Start with Free Plan**: Watchdog is lightweight, free plan is sufficient
2. **Monitor Logs**: Check `logs/watchdog.log` regularly
3. **Review Auto-Heal Reports**: Review `tests/reports/autoheal-report.md` after triggers
4. **Adjust Thresholds**: Fine-tune thresholds based on your error patterns
5. **Use Slack Notifications**: Set up Slack webhook for real-time alerts

## Integration with CI/CD

Add to your CI pipeline:

```yaml
- name: Run Watchdog Locally
  run: |
    export RENDER_SERVICE_ID=${{ secrets.RENDER_SERVICE_ID }}
    export RENDER_API_KEY=${{ secrets.RENDER_API_KEY }}
    pnpm watchdog
  env:
    E2E_BASE_URL: ${{ env.API_URL }}
    TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
```

## Limitations

1. **Render API Rate Limits**: Polls every 10 minutes to avoid rate limits
2. **Pattern Matching**: Uses regex, may have false positives/negatives
3. **Threshold-Based**: Only triggers if errors exceed threshold
4. **No Code Changes**: Auto-healing only fixes config, not code bugs

## Future Enhancements

- [ ] Machine learning for pattern detection
- [ ] Code-level auto-healing (not just config)
- [ ] Multiple service monitoring
- [ ] Custom alert rules per service
- [ ] Integration with PagerDuty, Opsgenie
- [ ] Dashboard for monitoring status

